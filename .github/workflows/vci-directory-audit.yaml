name: Nightly audit

on:
  schedule:
    - cron: '30 4 * * *'
  workflow_dispatch:
  push:
    tags:
      - audit*

jobs:
  vci-directory-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: npm setup
        run: |
          cd scripts/vci-directory-auditor
          npm install
          npm run build --if-present

      - name: run audit scripts
        run: |
          cd scripts/vci-directory-auditor
          npm run audit -- -o ../../logs/new_log.json -p ../../logs/daily_log.json -s ../../logs/daily_log_snapshot.json -a ../../logs/daily_audit.json -d ../../vci-issuers.json
          mv ../../logs/new_log.json ../../logs/daily_log.json
          npm run assemble -- -s ../../logs/vci_snapshot.json -c ../../logs/daily_log_snapshot.json

      - name: sign snapshot
        env:
          PRIVATE_SIG_KEY_PWD: ${{ secrets.PRIVATE_SIG_KEY_PWD }}
          PRIVATE_SIG_KEY: ${{ secrets.PRIVATE_SIG_KEY }}
        run: |
          echo "$PRIVATE_SIG_KEY" > private.pem
          openssl dgst -sha512 -sign private.pem -out logs/vci_snapshot.sig -passin env:PRIVATE_SIG_KEY_PWD logs/vci_snapshot.json
          rm private.pem

      - name: Upload snapshot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audit-log-files
          path: logs/*

  create-pr-job:
    needs: vci-directory-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download snapshot artifacts
        uses: actions/download-artifact@v4
        with:
          name: audit-log-files
          path: logs/

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are changes
          if [[ -z `git status --porcelain` ]]; then
            echo "No changes detected, skipping PR creation"
            exit 0
          fi

          # Configure git
          git config user.name "VCI Directory Audit Bot"
          git config user.email "noreply@thecommonsproject.org"

          # Create branch name with date
          BRANCH_NAME="audit/snapshot-$(date -u +%Y-%m-%d-%H%M%S)"

          # Commit changes
          git checkout -b "$BRANCH_NAME"
          git add -f logs/daily_log.json
          git add -f logs/daily_log_snapshot.json
          git add -f logs/daily_audit.json
          git add -f logs/vci_snapshot.json
          git add -f logs/vci_snapshot.sig
          git commit -m "Daily VCI directory audit snapshot

          Automated snapshot update from nightly audit.

          - Updated vci_snapshot.json with latest issuer keys
          - Generated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - Audit log: logs/daily_audit.json"

          # Add audit index entry
          COMMIT=$(git rev-parse HEAD)
          DATETIME=$(git log -n 1 --no-decorate --date=iso-strict -- logs/daily_log.json | head -3 | grep Date | cut -c 9-)
          echo "$COMMIT, $DATETIME" >> logs/audit-index.csv
          git add -f logs/audit-index.csv
          git commit -m "Update audit index with latest snapshot commit"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR with summary from audit log
          ISSUER_COUNT=$(jq '.issuerCount' logs/daily_audit.json)
          ERROR_COUNT=$(jq '.issuersWithErrors | length' logs/daily_audit.json)

          gh pr create \
            --title "ðŸ¤– Automated VCI Directory Snapshot Update - $(date -u +%Y-%m-%d)" \
            --body "## Automated Daily Audit Snapshot

          This PR contains the automated daily update of the VCI directory snapshot.

          ### Summary
          - **Total Issuers**: $ISSUER_COUNT
          - **Issuers with Errors**: $ERROR_COUNT
          - **Audit Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ### What's Included
          - Updated \`logs/vci_snapshot.json\` with latest issuer keys and CRLs
          - Updated \`logs/daily_log.json\` with full audit details
          - Updated \`logs/daily_audit.json\` with audit summary
          - Updated signature file \`logs/vci_snapshot.sig\`
          - Updated audit index

          ### Automated Checks
          âœ… Test scripts validation
          âœ… Issuer file validation

          ---
          ðŸ¤– *This PR will be automatically merged once all required checks pass.*

          *If you see issues with this snapshot, you can close this PR to prevent the merge.*" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "automated" \
            --label "audit"
